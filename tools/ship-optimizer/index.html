<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ship Optimizer</title>
  <link rel="stylesheet" href="../../shared/styles.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="title-row">
      <h1>Ship Optimizer</h1>
      <button class="btn-icon help-btn" aria-label="Help">?</button>
    </div>
    <div class="toggle-group">
      <button class="toggle-btn active" data-view="optimizer">Optimizer</button>
      <button class="toggle-btn" data-view="roi">Upgrade ROI</button>
    </div>
    <div id="optimizerView">
      <!-- Room Configuration -->
      <div class="card">
        <h2>Ship Configuration</h2>
        <div id="roomConfig" class="room-config">
          <!-- Rendered by JS -->
        </div>
      </div>

      <!-- Character Selection -->
      <div class="card">
        <h2>Available Characters</h2>
        <div class="character-controls">
          <button id="selectAll" class="btn btn-secondary">Select All</button>
          <button id="selectNone" class="btn btn-secondary">Select None</button>
          <button id="optimizeBtn" class="btn btn-primary">Optimize</button>
          <span id="optimizeProgress" class="optimize-progress"></span>
          <div class="global-elite-controls">
            <span class="global-elite-label">Set all to:</span>
            <button class="global-elite-btn" data-level="e1">E1</button>
            <button class="global-elite-btn" data-level="e2">E2</button>
            <button class="global-elite-btn" data-level="e3">E3</button>
            <button class="global-elite-btn active" data-level="e4">E4</button>
          </div>
        </div>
        <div id="characterList" class="character-list">
          <!-- Characters rendered by JS -->
        </div>
      </div>

      <!-- Results -->
      <div class="card" id="resultsCard" hidden>
        <h2>Suggested Layout</h2>
        <p class="hint">Drag and drop operators between rooms, or from the character list above.</p>
        <p class="hint text-error" id="staleHint" hidden>Config changed since last optimization — re-run to update.</p>
        <div id="resultsContainer">
          <!-- Results rendered by JS -->
        </div>
      </div>
    </div>

    <div id="roiView" hidden>
      <div class="card">
        <h2>Upgrade ROI Advisor</h2>
        <p class="hint">Analyzes which operator promotion gives the biggest ship efficiency gain.</p>
        <div class="roi-controls">
          <button id="calculateROIBtn" class="btn btn-primary">Calculate ROI</button>
          <span id="roiProgress" class="optimize-progress"></span>
        </div>
        <div id="roiResultsContainer"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="helpModal">
    <div class="modal">
      <button class="modal-close">&times;</button>
      <h2>Math</h2>
      
      <p><strong>Optimization</strong></p>
      <p>The algorithm iterates over all possible and meaningful Control Nexus permutations, it then fills other rooms based on the following heuristic:</p>
      <p><code>score = production_bonus + (uptime_gain * 2.2)</code><p>
      <p>This comes from the fact that baseline production is 220% assuming the room is filled with 3 non-matching operators. This is why I count every 1% uptime gain as 2.2% effective production gain.</p>
      <p>This gives us a good enough starting point from which we can then try to further optimize by exhaustive search until the score is no longer improving.</p> 	

      <p><strong>Efficiency Calculation</strong></p>
      <p>Base efficiency depends on operators in room:</p>
      <p><code>base = 100% + (40% × operator_count)</code></p>
      <p>Matching stat bonuses sum up and multiply the base:</p>
      <p><code>nominal = base × (1 + stat_bonus%)</code></p>

      <p><strong>Mood System</strong></p>
      <p>Operators work until mood hits 0%, then rest. Base rates:</p>
      <p><code>mood_drop = 7% per hour</code></p>
      <p><code>mood_regen = 12% per hour</code></p>
      <p>Slow Mood Drop reduces drop rate, Mood Regen (Control Nexus) increases regen for all:</p>
      <p><code>work_hours = 100 / (7 × (1 − slow_mood_drop%))</code></p>
      <p><code>rest_hours = 100 / (12 × (1 + mood_regen%))</code></p>

      <p><strong>Effective Efficiency</strong></p>
      <p>Uptime accounts for work/rest cycle:</p>
      <p><code>uptime = work_hours / (work_hours + rest_hours)</code></p>
      <p><code>effective = nominal × uptime</code></p>
    </div>
  </div>

  <script type="module" src="js/main.js"></script>
  <script type="module" src="../../shared/todo.js"></script>
</body>
</html>
